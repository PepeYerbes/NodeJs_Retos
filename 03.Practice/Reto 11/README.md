# üîë Reto 11: Autenticaci√≥n con JWT

> **Objetivo**: Implementar un flujo completo de autenticaci√≥n en Express utilizando JSON Web Tokens (JWT).

## üéØ Descripci√≥n del Reto

Crear un sistema de autenticaci√≥n robusto que incluya login y protecci√≥n de rutas usando JWT. Este reto te ense√±ar√° los fundamentos de la autenticaci√≥n en APIs REST, un concepto esencial en el desarrollo backend.

---

## üöß Requisitos T√©cnicos

### **üìç Endpoints Requeridos**

#### **1. POST /login**

- **Funci√≥n**: Autenticar usuario y generar token
- **Body**: `{ "correo": "email", "contrase√±a": "password" }`
- **Respuesta exitosa**: Token JWT
- **Respuesta error**: 401 Unauthorized

#### **2. GET /perfil**

- **Funci√≥n**: Obtener datos del usuario autenticado
- **Header requerido**: `Authorization: Bearer <token>`
- **Respuesta exitosa**: Datos del usuario
- **Respuesta error**: 401/403 si token inv√°lido

---

## üß± Estructura Sugerida

```
reto-autenticacion/
‚îú‚îÄ‚îÄ üìÑ package.json
‚îú‚îÄ‚îÄ üñ•Ô∏è server.js              # Servidor principal
‚îú‚îÄ‚îÄ üìÅ routes/
‚îÇ   ‚îú‚îÄ‚îÄ üõ£Ô∏è auth.js            # Rutas de autenticaci√≥n
‚îÇ   ‚îî‚îÄ‚îÄ üõ£Ô∏è perfil.js          # Rutas protegidas
‚îú‚îÄ‚îÄ üìÅ controllers/
‚îÇ   ‚îú‚îÄ‚îÄ üéØ authController.js   # L√≥gica de auth
‚îÇ   ‚îî‚îÄ‚îÄ üéØ perfilController.js # L√≥gica de perfil
‚îú‚îÄ‚îÄ üìÅ middlewares/
‚îÇ   ‚îî‚îÄ‚îÄ üõ°Ô∏è verificarToken.js  # Middleware JWT
‚îú‚îÄ‚îÄ üìÅ data/
‚îÇ   ‚îî‚îÄ‚îÄ üìä usuarios.json       # Datos simulados
‚îî‚îÄ‚îÄ üîß .env                    # Variables de entorno
```

---

## üß™ Datos de Prueba

### **üìä data/usuarios.json**

```json
[
  {
    "id": 1,
    "nombre": "Juan P√©rez",
    "correo": "juan@correo.com",
    "contrase√±a": "123456",
    "rol": "usuario"
  },
  {
    "id": 2,
    "nombre": "Mar√≠a Garc√≠a",
    "correo": "maria@correo.com",
    "contrase√±a": "password123",
    "rol": "admin"
  }
]
```

### **üîß .env**

```env
PORT=3000
JWT_SECRET=mi_super_secreto_jwt_2025
JWT_EXPIRES_IN=24h
NODE_ENV=development
```

---

## üì¶ Dependencias Necesarias

```bash
# Dependencias principales
npm install express jsonwebtoken dotenv

# Dependencias de desarrollo (opcional)
npm install -D nodemon

# package.json scripts sugeridos
{
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js"
  }
}
```

---

## üß© Implementaci√≥n Completa

### **1. üñ•Ô∏è server.js**

```javascript
import express from "express";
import dotenv from "dotenv";
import authRoutes from "./routes/auth.js";
import perfilRoutes from "./routes/perfil.js";

// Configurar variables de entorno
dotenv.config();

const app = express();
const PORT = process.env.PORT || 3000;

// Middlewares
app.use(express.json());

// Routes
app.use("/api/auth", authRoutes);
app.use("/api", perfilRoutes);

// Ruta de prueba
app.get("/", (req, res) => {
  res.json({
    message: "üîë Servidor de autenticaci√≥n JWT funcionando",
    endpoints: {
      login: "POST /api/auth/login",
      perfil: "GET /api/perfil",
    },
  });
});

// Error handling
app.use((err, req, res, next) => {
  console.error(err.stack);
  res.status(500).json({
    success: false,
    error: "Error interno del servidor",
  });
});

app.listen(PORT, () => {
  console.log(`üöÄ Servidor corriendo en puerto ${PORT}`);
});
```

### **2. üõ£Ô∏è routes/auth.js**

```javascript
import express from "express";
import { login } from "../controllers/authController.js";

const router = express.Router();

// POST /api/auth/login
router.post("/login", login);

export default router;
```

### **3. üéØ controllers/authController.js**

```javascript
import jwt from "jsonwebtoken";
import fs from "fs/promises";
import path from "path";

// Funci√≥n para leer usuarios del archivo JSON
const leerUsuarios = async () => {
  try {
    const rutaUsuarios = path.join(process.cwd(), "data", "usuarios.json");
    const data = await fs.readFile(rutaUsuarios, "utf-8");
    return JSON.parse(data);
  } catch (error) {
    console.error("Error leyendo usuarios:", error);
    return [];
  }
};

export const login = async (req, res) => {
  try {
    const { correo, contrase√±a } = req.body;

    // Validar que se enviaron los campos requeridos
    if (!correo || !contrase√±a) {
      return res.status(400).json({
        success: false,
        error: "Correo y contrase√±a son requeridos",
      });
    }

    // Leer usuarios del archivo
    const usuarios = await leerUsuarios();

    // Buscar usuario por correo y contrase√±a
    const usuario = usuarios.find(
      (u) => u.correo === correo && u.contrase√±a === contrase√±a
    );

    if (!usuario) {
      return res.status(401).json({
        success: false,
        error: "Credenciales inv√°lidas",
      });
    }

    // Generar token JWT
    const payload = {
      id: usuario.id,
      correo: usuario.correo,
      nombre: usuario.nombre,
      rol: usuario.rol,
    };

    const token = jwt.sign(payload, process.env.JWT_SECRET, {
      expiresIn: process.env.JWT_EXPIRES_IN || "24h",
    });

    // Respuesta exitosa
    res.json({
      success: true,
      message: "Login exitoso",
      token,
      usuario: {
        id: usuario.id,
        nombre: usuario.nombre,
        correo: usuario.correo,
        rol: usuario.rol,
      },
    });
  } catch (error) {
    console.error("Error en login:", error);
    res.status(500).json({
      success: false,
      error: "Error interno del servidor",
    });
  }
};
```

### **4. üõ°Ô∏è middlewares/verificarToken.js**

```javascript
import jwt from "jsonwebtoken";

export const verificarToken = (req, res, next) => {
  try {
    // Obtener token del header Authorization
    const authHeader = req.headers.authorization;

    if (!authHeader) {
      return res.status(401).json({
        success: false,
        error: "Token no proporcionado",
      });
    }

    // Verificar formato: "Bearer <token>"
    const token = authHeader.split(" ")[1];

    if (!token) {
      return res.status(401).json({
        success: false,
        error: "Formato de token inv√°lido",
      });
    }

    // Verificar y decodificar token
    const decoded = jwt.verify(token, process.env.JWT_SECRET);

    // Agregar informaci√≥n del usuario al request
    req.usuario = decoded;
    next();
  } catch (error) {
    if (error.name === "TokenExpiredError") {
      return res.status(401).json({
        success: false,
        error: "Token expirado",
      });
    }

    if (error.name === "JsonWebTokenError") {
      return res.status(403).json({
        success: false,
        error: "Token inv√°lido",
      });
    }

    return res.status(500).json({
      success: false,
      error: "Error verificando token",
    });
  }
};
```

### **5. üõ£Ô∏è routes/perfil.js**

```javascript
import express from "express";
import { obtenerPerfil } from "../controllers/perfilController.js";
import { verificarToken } from "../middlewares/verificarToken.js";

const router = express.Router();

// GET /api/perfil (protegida)
router.get("/perfil", verificarToken, obtenerPerfil);

export default router;
```

### **6. üéØ controllers/perfilController.js**

```javascript
export const obtenerPerfil = (req, res) => {
  try {
    // El middleware verificarToken ya nos dio req.usuario
    const usuario = req.usuario;

    res.json({
      success: true,
      message: "Perfil obtenido exitosamente",
      data: {
        id: usuario.id,
        nombre: usuario.nombre,
        correo: usuario.correo,
        rol: usuario.rol,
        // Informaci√≥n adicional que quieras mostrar
        ultimoAcceso: new Date().toISOString(),
      },
    });
  } catch (error) {
    console.error("Error obteniendo perfil:", error);
    res.status(500).json({
      success: false,
      error: "Error interno del servidor",
    });
  }
};
```

---

## üß™ Testing Manual

### **1. ‚úÖ Realizar Login**

```bash
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "correo": "juan@correo.com",
    "contrase√±a": "123456"
  }'
```

**Respuesta esperada:**

```json
{
  "success": true,
  "message": "Login exitoso",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "usuario": {
    "id": 1,
    "nombre": "Juan P√©rez",
    "correo": "juan@correo.com",
    "rol": "usuario"
  }
}
```

### **2. üîê Acceder al Perfil**

```bash
# Usar el token obtenido en el paso anterior
curl -X GET http://localhost:3000/api/perfil \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

### **3. ‚ùå Casos de Error**

#### **Login con credenciales incorrectas:**

```bash
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "correo": "noexiste@correo.com",
    "contrase√±a": "wrongpassword"
  }'
```

#### **Perfil sin token:**

```bash
curl -X GET http://localhost:3000/api/perfil
```

#### **Perfil con token inv√°lido:**

```bash
curl -X GET http://localhost:3000/api/perfil \
  -H "Authorization: Bearer token_invalido"
```

---

## ‚úÖ Criterios de √âxito

### **üîë Login Exitoso**

```json
{
  "success": true,
  "message": "Login exitoso",
  "token": "jwt_token_aqui",
  "usuario": {
    "id": 1,
    "nombre": "Juan P√©rez",
    "correo": "juan@correo.com",
    "rol": "usuario"
  }
}
```

### **‚ùå Login Fallido**

```json
{
  "success": false,
  "error": "Credenciales inv√°lidas"
}
```

### **üë§ Perfil Exitoso**

```json
{
  "success": true,
  "message": "Perfil obtenido exitosamente",
  "data": {
    "id": 1,
    "nombre": "Juan P√©rez",
    "correo": "juan@correo.com",
    "rol": "usuario",
    "ultimoAcceso": "2025-01-07T..."
  }
}
```

### **üö´ Acceso Denegado**

```json
{
  "success": false,
  "error": "Token no proporcionado"
}
```

---

## üî• Retos Adicionales (Opcional)

### **üåü Level Up:**

1. **Hash de contrase√±as**: Usar `bcrypt` en lugar de contrase√±as en texto plano
2. **Refresh tokens**: Implementar sistema de refresh tokens
3. **M√∫ltiples roles**: Middleware para verificar roles espec√≠ficos
4. **Rate limiting**: Limitar intentos de login por IP
5. **Logout**: Blacklist de tokens para logout

### **üîß Ejemplos Avanzados:**

```javascript
// Middleware para verificar rol admin
export const verificarAdmin = (req, res, next) => {
  if (req.usuario.rol !== "admin") {
    return res.status(403).json({
      success: false,
      error: "Acceso denegado: se requiere rol de administrador",
    });
  }
  next();
};

// Hash de contrase√±a con bcrypt
import bcrypt from "bcrypt";

const contrase√±aHasheada = await bcrypt.hash(contrase√±a, 10);
const esValida = await bcrypt.compare(contrase√±a, usuario.contrase√±a);
```

---

## üåç Recursos Adicionales

### **üìö Documentaci√≥n:**

- [JWT.io](https://jwt.io/) - Debugger y documentaci√≥n JWT
- [jsonwebtoken npm](https://www.npmjs.com/package/jsonwebtoken)
- [Express Security Best Practices](https://expressjs.com/en/advanced/best-practice-security.html)

### **üéØ Ejercicios Similares:**

- [Basic Authentication - Codewars](https://www.codewars.com/kata/basic-authentication)
- [JWT Auth Tutorial - freeCodeCamp](https://www.freecodecamp.org/news/how-to-make-jwt-authentication-with-express/)

### **üîó Referencias del Curso:**

- [Authentication FAQ](../../05.Resources/05.FAQ/api-development.md#autenticaci√≥n-jwt)
- [JWT Examples](../../05.Resources/03.Quick-Reference/jwt-examples.md)
- [Security Best Practices](../../05.Resources/02.Documentation/security.md)

---

## ‚úÖ Checklist de Completado

- [ ] ‚úÖ Servidor Express configurado con variables de entorno
- [ ] üîë Endpoint POST /login implementado
- [ ] üìä Sistema de lectura de usuarios desde JSON
- [ ] üé´ Generaci√≥n de tokens JWT funcionando
- [ ] üõ°Ô∏è Middleware de verificaci√≥n de token creado
- [ ] üë§ Endpoint GET /perfil protegido
- [ ] ‚ùå Manejo de errores (credenciales inv√°lidas, token expirado, etc.)
- [ ] üß™ Testing manual realizado con curl/Postman
- [ ] üìÑ Respuestas JSON con formato consistente

---

## üí° Conceptos Clave Aprendidos

- **üîê Autenticaci√≥n vs Autorizaci√≥n**
- **üé´ ¬øQu√© son los JWT?**
- **üõ°Ô∏è Middlewares para proteger rutas**
- **üîë Headers de autorizaci√≥n**
- **‚ùå Manejo de errores de seguridad**
- **‚öôÔ∏è Variables de entorno para secretos**

---

**üéØ Tiempo estimado**: 3-4 horas
**üìä Dificultad**: ‚≠ê‚≠ê‚≠ê‚≠ê (Intermedio-Avanzado)
**üè∑Ô∏è Tags**: `jwt`, `authentication`, `middleware`, `security`, `express`

---

_üîí **Pro tip**: La autenticaci√≥n JWT es la base de la mayor√≠a de aplicaciones web modernas. ¬°Domina este concepto y tendr√°s una habilidad muy valorada!_
